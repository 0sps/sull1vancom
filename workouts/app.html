<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <title>SEAN'S LOG | Workout Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-tertiary: #1a1a1d;
            --accent-primary: #ff3d00;
            --accent-secondary: #ff6d3d;
            --accent-glow: rgba(255, 61, 0, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a5;
            --text-muted: #606065;
            --success: #00ff88;
            --warning: #ffbb00;
            --border: #2a2a2d;
            --gradient-fire: linear-gradient(135deg, #ff3d00 0%, #ff6d3d 50%, #ffbb00 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', monospace;
            font-size: 17px;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at 20% 20%, rgba(255, 61, 0, 0.08) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(255, 109, 61, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0 40px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .logo {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .logo h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            letter-spacing: 4px;
            background: var(--gradient-fire);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
        }

        .sync-status {
            font-size: 0.82rem;
            padding: 6px 12px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-status.synced {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .sync-status.syncing {
            background: rgba(255, 187, 0, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 187, 0, 0.3);
        }

        .sync-status.error {
            background: rgba(255, 61, 90, 0.1);
            color: #ff3d5a;
            border: 1px solid rgba(255, 61, 90, 0.3);
        }

        .current-date {
            text-align: right;
        }

        .current-date .day-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: var(--accent-primary);
            letter-spacing: 2px;
        }

        .current-date .date-full {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-tab:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--text-primary);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .section-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 2px;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--accent-primary);
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .workout-day-badge {
            background: var(--gradient-fire);
            padding: 8px 16px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 2px;
        }

        .workout-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 1px;
            margin-top: 8px;
        }

        .workout-title-link {
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
            cursor: pointer;
            display: block;
        }

        .workout-title-link:hover .workout-day-badge {
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .workout-title-link:hover .workout-name {
            color: var(--accent-primary);
        }

        .workout-meta {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .exercise-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .exercise-item:hover {
            border-color: var(--accent-primary);
        }

        .exercise-item.completed {
            border-color: var(--success);
            background: rgba(0, 255, 136, 0.05);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 10px;
        }

        .exercise-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 1px;
        }

        .exercise-sets {
            font-size: 0.8rem;
            color: var(--accent-secondary);
            background: rgba(255, 61, 0, 0.1);
            padding: 4px 12px;
            width: 100%;
            text-align: center;
        }

        .exercise-muscles {
            font-size: 0.82rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .sets-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #exerciseList {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }

        .set-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .set-label {
            font-size: 0.89rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 6px;
        }



        .warmup-btn {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 2px solid var(--warning);
            background: transparent;
            color: var(--text-muted);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            opacity: 0.4;
        }

        .warmup-btn.active {
            background: rgba(255, 187, 0, 0.2);
            color: var(--warning);
            opacity: 1;
            box-shadow: 0 0 12px rgba(255, 187, 0, 0.5), 0 0 24px rgba(255, 187, 0, 0.3);
            text-shadow: 0 0 8px rgba(255, 187, 0, 0.8);
        }

        .warmup-btn:hover {
            opacity: 0.8;
        }

        .set-inputs {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .set-input {
            padding: 17px 12px;
            background: transparent;
            border: none;
            border-bottom: 2px solid rgba(255, 255, 255, 0.9);
            color: var(--text-primary);
            font-family: Arial, sans-serif;
            font-size: 1.8rem;
            font-weight: bold;
            font-style: italic;
            text-align: center;
        }

        .set-input[data-type="reps"] {
            width: 40%;
        }

        .set-input[data-type="weight"] {
            width: 60%;
        }

        .set-input:focus {
            outline: none;
            border-bottom-color: var(--accent-primary);
        }

        /* Hide number input spinner buttons */
        .set-input::-webkit-outer-spin-button,
        .set-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .set-input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .set-input::placeholder {
            color: rgba(176, 176, 181, 0.7);
            font-size: 1.2rem;
            font-weight: 700;
        }

        .input-separator {
            color: rgba(255, 255, 255, 0.5);
            font-size: 2rem;
            font-weight: 300;
            user-select: none;
        }

        .btn {
            padding: 12px 24px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: var(--gradient-fire);
            color: var(--text-primary);
        }

        .btn-primary:hover {
            box-shadow: 0 0 30px var(--accent-glow);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-primary.success {
            background: var(--success) !important;
            color: #000 !important;
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.6) !important;
            transform: scale(1.05) translateY(-2px) !important;
            animation: successPulse 2s infinite;
        }

        @keyframes successPulse {
            0% {
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
            }

            50% {
                box-shadow: 0 0 60px rgba(0, 255, 136, 0.8);
            }

            100% {
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
            }
        }

        .set-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .set-table th {
            background: var(--bg-tertiary);
            padding: 12px;
            text-align: left;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
            color: var(--text-muted);
            border-bottom: 2px solid var(--border);
        }

        .set-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .set-table tbody tr {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .set-table tbody tr:hover {
            background: rgba(255, 61, 0, 0.05);
        }

        .set-table tbody tr.selected {
            position: relative;
        }

        .delete-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(198, 40, 40, 0.5);
            /* Initial red overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 100;
            pointer-events: auto;
            border-radius: 4px;
            /* Match row border radius if applicable */
        }

        .delete-overlay.deleted-state {
            background: rgba(0, 255, 136, 0.9) !important;
        }

        .delete-set-btn,
        .cancel-set-btn {
            padding: 10px 24px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .delete-set-btn {
            background: rgba(198, 40, 40, 0.1);
            border: 2px solid #c62828;
            color: #c62828;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .delete-set-btn:hover {
            background: rgba(198, 40, 40, 0.2);
        }

        .cancel-set-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #fbb7b7;
            color: #fbb7b7;
        }

        .cancel-set-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-export {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
        }

        .btn-export:hover {
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 6px 12px;
            font-size: 0.82rem;
        }

        .btn-logout:hover {
            border-color: #ff3d5a;
            color: #ff3d5a;
        }

        .log-sidebar {
            position: sticky;
            top: 20px;
        }

        .log-entry {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .log-entry:hover {
            border-color: var(--accent-primary);
        }

        .log-date {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 1px;
            color: var(--accent-secondary);
        }

        .log-workout-name {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin: 4px 0;
        }

        .log-stats {
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        .log-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .exercise-library {
            display: none;
        }

        .exercise-library.active {
            display: block;
        }

        .library-search {
            width: 100%;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .library-search:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .muscle-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .filter-chip {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.82rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s ease;
        }

        .filter-chip:hover,
        .filter-chip.active {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .library-exercise {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .library-exercise:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .library-exercise-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .library-exercise-muscles {
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        .library-exercise-category {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(255, 61, 0, 0.1);
            color: var(--accent-secondary);
            font-size: 0.77rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
        }

        .plan-view {
            display: none;
        }

        .plan-view.active {
            display: block;
        }

        .plan-day {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .plan-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .plan-day-header:hover {
            background: rgba(255, 61, 0, 0.05);
        }

        .plan-day-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 1px;
        }

        .plan-day-subtitle {
            font-size: 0.87rem;
            color: var(--text-muted);
        }

        .plan-day-exercises {
            padding: 0 20px 20px;
            display: none;
        }

        .plan-day.expanded .plan-day-exercises {
            display: block;
        }

        .plan-exercise {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .plan-exercise:last-child {
            border-bottom: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Make set inputs more compact on mobile */
            .set-input {
                font-size: 1.4rem;
                padding: 12px 8px;
            }

            .set-input::placeholder {
                font-size: 1rem;
            }

            .input-separator {
                font-size: 1.5rem;
            }

            .set-inputs {
                gap: 8px;
            }

            .set-table th:nth-child(6),
            .set-table td:nth-child(6) {
                display: none;
            }

            .set-table th,
            .set-table td {
                padding: 10px 8px;
                font-size: 0.8rem;
            }
        }

        .stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            background: var(--gradient-fire);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.82rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        .complete-workout-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slideIn 0.4s ease forwards;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Set management buttons - no animations, just color changes on hover */
        .btn-add-set {
            transition: background-color 0.15s ease, border-color 0.15s ease;
        }

        .btn-add-set:hover {
            background: rgba(0, 255, 136, 0.2) !important;
            border-color: var(--success) !important;
        }

        .btn-remove-set {
            transition: background-color 0.15s ease, border-color 0.15s ease;
        }

        .btn-remove-set:hover:not(:disabled) {
            background: rgba(255, 61, 90, 0.2) !important;
            border-color: #ff3d5a !important;
        }

        .btn-remove-set:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .rest-day-message {
            text-align: center;
            padding: 60px 20px;
        }

        .rest-day-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .rest-day-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .rest-day-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-history {
            padding: 4px 10px;
            font-size: 0.77rem;
            background: rgba(255, 187, 0, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
            font-family: 'Space Mono', monospace;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
        }

        .btn-history:hover {
            background: rgba(255, 187, 0, 0.2);
            box-shadow: 0 0 10px rgba(255, 187, 0, 0.3);
        }

        .history-set {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            margin-bottom: 6px;
            border-left: 3px solid var(--accent-primary);
        }

        .history-set.warmup {
            border-left-color: var(--warning);
        }

        .history-date {
            color: var(--accent-secondary);
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .toggle-arrow {
            color: var(--text-muted);
            transition: transform 0.3s ease;
        }

        .plan-day.expanded .toggle-arrow {
            transform: rotate(180deg);
        }

        .export-banner {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 204, 106, 0.05) 100%);
            border: 1px solid rgba(0, 255, 136, 0.3);
            padding: 16px 20px;
            margin-top: 40px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .export-banner-text {
            font-size: 0.85rem;
            color: var(--success);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading your workouts...</p>
    </div>

    <div class="bg-pattern"></div>
    <div class="container">
        <header>
            <div class="logo">
                <a href="app.html">
                    <h1>SEAN'S LOG</h1>
                    <!--  modify this title <a href so that there is no outline when it renders on the webpage -->
                    <style>
                        a {
                            text-decoration: none;
                        }
                    </style>
                </a>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <img class="user-avatar" id="userAvatar" src="" alt="User">
                    <span id="userEmail"></span>
                </div>
                <div class="sync-status synced" id="syncStatus">
                    <span id="syncIcon">âœ“</span>
                    <span id="syncText">Synced</span>
                </div>

                <button class="btn btn-logout" onclick="logout()">LOGOUT</button>
            </div>
            <div class="current-date">
                <div class="day-name" id="currentDayName"></div>
                <div class="date-full" id="currentDateFull"></div>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="workout">Today's Workout</button>
            <button class="nav-tab" data-tab="plan">Full Plan</button>
            <button class="nav-tab" data-tab="library">Exercise Library</button>
            <button class="nav-tab" data-tab="history">Workout History</button>
            <a href="stats.html" class="nav-tab"
                style="text-decoration: none; display: flex; align-items: center; gap: 8px;">Stats Dashboard</a>
        </nav>


        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalWorkouts">0</div>
                <div class="stat-label">Recent Workouts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSets">0</div>
                <div class="stat-label">Recent Sets</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalVolume">0</div>
                <div class="stat-label">Recent Volume (lbs)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="currentStreak">0</div>
                <div class="stat-label">Day Streak</div>
            </div>
        </div>
        <p
            style="text-align: center; color: var(--text-muted); font-size: 0.82rem; margin-top: -12px; margin-bottom: 30px;">
            Stats based on your last 60 workouts
        </p>

        <div id="workoutTab" class="tab-content">
            <div class="main-layout">
                <div class="workout-area">
                    <div class="section-card" id="workoutCard">
                        <div class="workout-header">
                            <div onclick="switchWorkout()" class="workout-title-link">
                                <div class="workout-day-badge" id="workoutDayBadge">DAY 1</div>
                                <h2 class="workout-name" id="workoutName">PUSH A</h2>
                                <p class="workout-meta" id="workoutMeta">Upper Chest & Shoulder Width â€¢ 12 Sets Total
                                </p>
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="switchWorkout()">Switch Day</button>
                        </div>
                        <div id="exerciseList"></div>
                        <div class="complete-workout-section">
                            <button class="btn btn-primary" id="completeWorkoutBtn" onclick="completeWorkout()">COMPLETE
                                WORKOUT</button>
                        </div>
                    </div>
                </div>
                <div class="log-sidebar">
                    <div class="section-card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 class="section-title" style="margin-bottom: 0;">Recent Logs</h3>
                            <button class="btn btn-secondary btn-small" onclick="openDeleteSetModal()"
                                style="background: rgba(255, 61, 90, 0.1); border-color: #ff3d5a; color: #ff3d5a;">Delete
                                Sets</button>
                        </div>
                        <div id="recentLogs"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="planTab" class="tab-content plan-view">
            <div class="section-card">
                <h3 class="section-title">Sean Sullivan's Training Plan</h3>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 24px;">Push/Pull/Legs Ã— 2 per
                    week â€¢ 72 sets total â€¢ Goal: Gain 15lbs muscle</p>
                <div id="planDays"></div>
            </div>
        </div>

        <div id="libraryTab" class="tab-content exercise-library">
            <div class="section-card">
                <h3 class="section-title">Exercise Library</h3>
                <input type="text" class="library-search" placeholder="Search exercises..." id="librarySearch">
                <div class="muscle-filter" id="muscleFilter"></div>
                <div class="library-grid" id="libraryGrid"></div>
            </div>
        </div>

        <div id="historyTab" class="tab-content" style="display: none;">
            <div class="section-card">
                <h3 class="section-title">Workout History</h3>
                <p id="historySubtitle" style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px;"></p>
                <div id="fullHistory"></div>
            </div>
        </div>

        <div class="export-banner">
            <span class="export-banner-text">ðŸ“¤ Export complete workout history for analytics</span>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-export btn-small" onclick="exportToCSV()">EXPORT ALL TO CSV</button>
                <button class="btn btn-secondary btn-small" onclick="openDeleteSetModal()"
                    style="background: rgba(255, 61, 90, 0.1); border-color: #ff3d5a; color: #ff3d5a;">DELETE
                    SETS</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="switchModal">
        <div class="modal">
            <h3 class="modal-title">Select Workout Day</h3>
            <div id="daySelector"></div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="closeSwitchModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="exerciseModal">
        <div class="modal">
            <h3 class="modal-title" id="modalExerciseName"></h3>
            <div id="modalExerciseDetails"></div>
            <div class="modal-actions">
                <button class="btn btn-primary btn-small"
                    onclick="loadWorkoutForEditing(document.getElementById('exerciseModal').dataset.logId)"
                    style="background: rgba(255, 187, 0, 0.2); border: 1px solid var(--warning); color: var(--warning);">
                    Edit</button>
                <button class="btn btn-secondary" onclick="closeExerciseModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="historyModal">
        <div class="modal">
            <h3 class="modal-title" id="historyModalTitle">EXERCISE HISTORY</h3>
            <div id="historyModalContent"></div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="closeHistoryModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="instructionsModal" onclick="closeInstructionsModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <h3 class="modal-title" id="instructionsModalTitle">INSTRUCTIONS</h3>
            <div id="instructionsModalContent" style="white-space: pre-wrap; line-height: 1.6; font-size: 0.95rem;">
            </div>
            <div class="modal-actions"><button class="btn btn-secondary"
                    onclick="closeInstructionsModal()">CLOSE</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal" style="max-width: 480px; width: 95%;">
            <h3 class="modal-title" id="editModalTitle">EDIT WORKOUT</h3>
            <p id="editModalSubtitle" style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.9rem;"></p>
            <div id="editExerciseList" style="margin-bottom: 24px;"></div>
            <div class="modal-actions"
                style="position: sticky; bottom: -32px; background: var(--bg-secondary); padding-top: 16px; margin-top: 0; border-top: 1px solid var(--border); z-index: 10;">
                <button class="btn btn-primary" id="saveEditsBtn" onclick="saveEditedWorkout()" style="flex: 2;">SAVE
                    EDITS</button>
                <button class="btn btn-secondary" onclick="closeEditModal()"
                    style="flex: 1; background: rgba(255, 61, 90, 0.1); border-color: #ff3d5a; color: #ff3d5a;">DISCARD
                    EDITS</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteSetModal">
        <div class="modal" style="max-width: 900px; width: 95%;">
            <h3 class="modal-title">DELETE INDIVIDUAL SETS</h3>
            <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.9rem;">Showing last 40 sets from
                recent workouts. Click a row to select, then confirm deletion.</p>
            <div id="deleteSetList" style="margin-bottom: 24px; max-height: 500px; overflow-y: auto;"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteSetModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="zeroRepsModal">
        <div class="modal" style="max-width: 500px; width: 90%;">
            <h3 class="modal-title">ZERO REPS DETECTED</h3>
            <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem; line-height: 1.5;">
                Some sets were detected with 0 reps. These sets will <strong>not be saved</strong> to your workout
                history.
            </p>
            <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem;">
                Do you still want to save this workout?
            </p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="confirmCompleteWorkout()" style="flex: 1;">YES, SAVE</button>
                <button class="btn btn-secondary" onclick="closeZeroRepsModal()" style="flex: 1;">NO, GO BACK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCGi3JKROngwpfXWqLIwRLrt1u3FEA7eNc",
            authDomain: "workout-c7be0.firebaseapp.com",
            projectId: "workout-c7be0",
            storageBucket: "workout-c7be0.firebasestorage.app",
            messagingSenderId: "625595909146",
            appId: "1:625595909146:web:c9808282e5a4c3ad0cbda3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ALLOWED_EMAIL = "sspsful@gmail.com";

        // Make Firebase functions available globally
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseCollection = collection;
        window.firebaseDoc = doc;
        window.firebaseGetDocs = getDocs;
        window.firebaseSetDoc = setDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseLimit = limit;
        window.firebaseSignOut = signOut;

        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== ALLOWED_EMAIL) {
                window.location.href = 'index.html';
            } else {
                // User is authenticated
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userAvatar').src = user.photoURL || '';
                window.currentUser = user;
                window.firebaseReady = true;
                if (window.onFirebaseReady) window.onFirebaseReady();
            }
        });

        window.logout = async function () {
            await signOut(auth);
            window.location.href = 'index.html';
        }
    </script>

    <script>
        // DATA LOADED FROM JSON FILES
        let exercisesData = {};  // Will be loaded from exercises.json
        let trainingPlanData = null;  // Will be loaded from training-plan.json
        let exerciseDatabase = [];  // Built from exercisesData after loading
        let trainingPlan = {};  // Built from trainingPlanData after loading

        // Helper functions to get exercise data
        function getExercise(id) {
            return exercisesData[id] || null;
        }

        // Get exercise in UI format (for rendering)
        function getExerciseForUI(id) {
            const data = exercisesData[id];
            if (!data) return null;
            return {
                id: id,
                name: data.name,
                muscles: data.muscles || [],
                category: data.category || '',
                equipment: data.equipment || '',
                instructions: data.instructions || '',
                notes: data.notes || ''
            };
        }

        function getExportName(id) {
            const exercise = exercisesData[id];
            return exercise ? exercise.exportName : id;
        }

        function getMultiplier(id) {
            const exercise = exercisesData[id];
            return exercise ? exercise.multiplier : 1;
        }

        // Load JSON data files
        async function loadExerciseData() {
            try {
                const response = await fetch('exercises.json');
                exercisesData = await response.json();

                // Build exerciseDatabase array for compatibility
                exerciseDatabase = Object.entries(exercisesData).map(([id, data]) => ({
                    id: id,
                    name: data.name,
                    muscles: data.muscles || [],
                    category: data.category || '',
                    equipment: data.equipment || '',
                    instructions: data.instructions || '',
                    notes: data.notes || ''
                }));

                return true;
            } catch (error) {
                console.error('Failed to load exercises.json:', error);
                return false;
            }
        }

        async function loadTrainingPlan() {
            try {
                const response = await fetch('training-plan.json');
                trainingPlanData = await response.json();

                // Convert to old format for compatibility
                const schedule = trainingPlanData.schedule || [];
                const workouts = trainingPlanData.workouts || {};

                // Map schedule to day1-day6, rest format
                trainingPlan = {};
                schedule.forEach((workoutName, index) => {
                    const dayKey = index === 3 ? 'rest' : `day${index < 3 ? index + 1 : index}`;
                    const workout = workouts[workoutName];

                    if (workout) {
                        trainingPlan[dayKey] = {
                            name: workoutName,
                            subtitle: workout.subtitle || '',
                            exercises: (workout.exercises || []).map(ex => {
                                const exercise = getExercise(ex.id);
                                return {
                                    exerciseId: ex.id,
                                    sets: ex.sets || 3,
                                    reps: ex.reps || '8-12',
                                    notes: exercise ? exercise.notes : ''
                                };
                            })
                        };
                    }
                });

                return true;
            } catch (error) {
                console.error('Failed to load training-plan.json:', error);
                return false;
            }
        }

        const dayToWorkout = { 0: 'day1', 1: 'day2', 2: 'day3', 3: 'rest', 4: 'day4', 5: 'day5', 6: 'day6' };
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        let workoutLogs = [];
        let currentWorkoutDay = null;
        let currentExerciseData = {};
        let currentSetCounts = {}; // Track number of sets per exercise !
        let editingLogData = null; // Store full log data when editing
        let activeFilter = null;
        let weightUnit = 'lbs'; // Default weight unit for display and input

        // Stats caching to avoid unnecessary recalculations
        let cachedStats = null;
        let cachedStatsVersion = 0;
        let isFullHistoryLoaded = false; // Track if we've loaded all history or just recent

        function invalidateStatsCache() {
            cachedStatsVersion++;
        }

        async function loadFromFirebase(limitCount = 60) {
            try {
                updateSyncStatus('syncing');
                const q = limitCount > 0
                    ? window.firebaseQuery(window.firebaseCollection(window.firebaseDb, 'workouts'), window.firebaseOrderBy('date', 'desc'), window.firebaseLimit(limitCount))
                    : window.firebaseQuery(window.firebaseCollection(window.firebaseDb, 'workouts'), window.firebaseOrderBy('date', 'desc'));
                const snapshot = await window.firebaseGetDocs(q);
                workoutLogs = [];
                snapshot.forEach(doc => workoutLogs.push({ id: doc.id, ...doc.data() }));
                isFullHistoryLoaded = (limitCount === 0); // Track if we loaded everything
                invalidateStatsCache();
                updateSyncStatus('synced');
                return true;
            } catch (error) {
                console.error('Firebase load error:', error);
                updateSyncStatus('error');
                return false;
            }
        }

        async function saveToFirebase(log) {
            try {
                updateSyncStatus('syncing');
                await window.firebaseSetDoc(window.firebaseDoc(window.firebaseDb, 'workouts', log.id.toString()), log);
                updateSyncStatus('synced');
                return true;
            } catch (error) {
                console.error('Firebase save error:', error);
                updateSyncStatus('error');
                return false;
            }
        }

        async function deleteFromFirebase(logId) {
            try {
                updateSyncStatus('syncing');
                await window.firebaseDeleteDoc(window.firebaseDoc(window.firebaseDb, 'workouts', logId.toString()));
                updateSyncStatus('synced');
                return true;
            } catch (error) {
                console.error('Firebase delete error:', error);
                updateSyncStatus('error');
                return false;
            }
        }

        function updateSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            const icon = document.getElementById('syncIcon');
            const text = document.getElementById('syncText');
            el.className = 'sync-status ' + status;
            if (status === 'synced') { icon.textContent = 'âœ“'; text.textContent = 'Synced'; }
            else if (status === 'syncing') { icon.textContent = 'â†»'; text.textContent = 'Syncing...'; }
            else { icon.textContent = '!'; text.textContent = 'Sync Error'; }
        }

        // LocalStorage persistence functions
        function saveWorkoutProgress() {
            const data = {
                workoutDay: currentWorkoutDay,
                exerciseData: currentExerciseData,
                setCounts: currentSetCounts,
                timestamp: Date.now()
            };
            localStorage.setItem('workoutProgress', JSON.stringify(data));
        }

        function loadWorkoutProgress() {
            try {
                const saved = localStorage.getItem('workoutProgress');
                if (!saved) return false;

                const data = JSON.parse(saved);
                const age = Date.now() - data.timestamp;
                const TWENTY_FOUR_HOURS = 24 * 60 * 60 * 1000;

                // Check if data is expired (> 24 hours)
                if (age > TWENTY_FOUR_HOURS) {
                    clearWorkoutProgress();
                    return false;
                }

                // Only load if it's for the same workout day
                if (data.workoutDay === currentWorkoutDay) {
                    currentExerciseData = data.exerciseData || {};
                    currentSetCounts = data.setCounts || {};
                    return true;
                }

                return false;
            } catch (error) {
                console.error('Error loading workout progress:', error);
                return false;
            }
        }

        function clearWorkoutProgress() {
            localStorage.removeItem('workoutProgress');
        }



        function formatDateForCSV(date) {
            const d = new Date(date);
            const pad = n => String(n).padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())} +0000`;
        }

        function lbsToKg(lbs) { return lbs * 0.45359237; }
        function kgToLbs(kg) { return kg / 0.45359237; }
        // Display weight: convert kg to lbs and round to integer
        function displayWeight(kgWeight) { return Math.round(kgToLbs(kgWeight)); }
        // Helper to compare log IDs (handles both string and number types)
        function compareLogIds(id1, id2) { return id1.toString() === id2.toString(); }


        function exportToCSV() {
            if (workoutLogs.length === 0) { alert('No workout data to export!'); return; }
            let csv = 'Date,Exercise,Reps,Weight(kg),Duration(s),Distance(m),Incline,Resistance,isWarmup,Note,multiplier\n';
            workoutLogs.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(log => {
                const dateStr = formatDateForCSV(log.date);
                log.exercises.forEach(ex => {
                    const exportName = getExportName(ex.id);
                    const multiplier = getMultiplier(ex.id);
                    ex.sets.forEach(set => {
                        // Data is always stored in kg, no conversion needed
                        const weightKg = set.weight || 0;
                        const isWarmup = set.isWarmup ? 'True' : 'False';
                        csv += `${dateStr},${exportName},${set.reps || 0},${weightKg},0.0,0.0,0.0,0.0,${isWarmup},,${multiplier}.0\n`;
                    });
                });
            });
            downloadCSV(csv, `WorkoutExport_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportSingleWorkout(log) {
            let csv = 'Date,Exercise,Reps,Weight(kg),Duration(s),Distance(m),Incline,Resistance,isWarmup,Note,multiplier\n';
            const dateStr = formatDateForCSV(log.date);
            log.exercises.forEach(ex => {
                const exportName = getExportName(ex.id);
                const multiplier = getMultiplier(ex.id);
                ex.sets.forEach(set => {
                    // Data is always stored in kg, no conversion needed
                    const weightKg = set.weight || 0;
                    const isWarmup = set.isWarmup ? 'True' : 'False';
                    csv += `${dateStr},${exportName},${set.reps || 0},${weightKg},0.0,0.0,0.0,0.0,${isWarmup},,${multiplier}.0\n`;
                });
            });
            downloadCSV(csv, `Workout_${log.workoutName.replace(/\s+/g, '_')}_${new Date(log.date).toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function init() {
            if (!window.firebaseReady) { window.onFirebaseReady = init; return; }

            // Load exercise and training plan data from JSON files
            const exercisesLoaded = await loadExerciseData();
            const planLoaded = await loadTrainingPlan();

            if (!exercisesLoaded || !planLoaded) {
                console.error('Failed to load data files');
                document.getElementById('loadingOverlay').innerHTML = '<div class="loading-text">Error loading data files. Please refresh.</div>';
                return;
            }

            await loadFromFirebase();
            document.getElementById('loadingOverlay').style.display = 'none';
            updateCurrentDate();
            setTodaysWorkout();

            // Load saved progress from localStorage
            loadWorkoutProgress();

            renderExercises();
            renderRecentLogs();
            renderPlanView();
            renderLibrary();
            updateStats();
            setupTabs();
        }

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDayName').textContent = dayNames[now.getDay()].toUpperCase();
            document.getElementById('currentDateFull').textContent = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        function setTodaysWorkout() {
            currentWorkoutDay = dayToWorkout[new Date().getDay()];
            updateWorkoutDisplay(true);
        }

        function updateWorkoutDisplay(clearProgress = false) {
            // Only clear progress when explicitly switching to a different workout day
            if (clearProgress) {
                currentExerciseData = {};
                currentSetCounts = {};
            }

            const workout = trainingPlan[currentWorkoutDay];
            const isRest = currentWorkoutDay === 'rest';
            document.getElementById('workoutDayBadge').textContent = isRest ? 'REST' : `DAY ${currentWorkoutDay.replace('day', '')}`;
            document.getElementById('workoutName').textContent = workout.name;
            document.getElementById('workoutMeta').textContent = isRest ? workout.subtitle : `${workout.subtitle} â€¢ ${workout.exercises.length * 4} Sets Total`;
            renderExercises();
        }

        function renderExercises() {
            const container = document.getElementById('exerciseList');
            const workout = trainingPlan[currentWorkoutDay];
            if (currentWorkoutDay === 'rest') {
                container.innerHTML = `<div class="rest-day-message"><div class="rest-day-icon">ðŸ§˜</div><h2 class="rest-day-title">REST & RECOVER</h2><p class="rest-day-subtitle">Complete rest or light activity. Your muscles grow during recovery!</p></div>`;
                return;
            }
            container.innerHTML = workout.exercises.map((ex, idx) => {
                const exercise = getExerciseForUI(ex.exerciseId);
                const exerciseKey = `${currentWorkoutDay}_${ex.exerciseId}`;

                // Initialize set count from workout plan if not already set
                if (!currentSetCounts[exerciseKey]) {
                    currentSetCounts[exerciseKey] = ex.sets;
                }

                const numSets = currentSetCounts[exerciseKey];

                const setsHtml = Array.from({ length: numSets }, (_, i) => {
                    const savedData = currentExerciseData[exerciseKey]?.[i] || {};
                    const savedReps = savedData.reps || '';
                    const savedWeight = savedData.weight || '';
                    const isWarmup = savedData.isWarmup !== undefined ? savedData.isWarmup : (i === 0);

                    return `<div class="set-input-group"><span class="set-label">Set ${i + 1}</span><button class="warmup-btn ${isWarmup ? 'active' : ''}" data-exercise="${exerciseKey}" data-set="${i}" onclick="toggleWarmup(this)">W</button>
                <div class="set-inputs"><input type="number" class="set-input" placeholder="REPS" value="${savedReps}" data-exercise="${exerciseKey}" data-set="${i}" data-type="reps" onchange="updateExerciseData(this)"><span class="input-separator">/</span><input type="number" class="set-input" placeholder="WEIGHT" value="${savedWeight}" data-exercise="${exerciseKey}" data-set="${i}" data-type="weight" onchange="updateExerciseData(this)"></div></div>`;
                }).join('');

                return `<div class="exercise-item" id="exercise-${exerciseKey}">
            <div class="exercise-header"><div style="flex: 1; min-width: 0;"><h4 class="exercise-name" onclick="showInstructions('${exercise.id}')" style="cursor: pointer; word-wrap: break-word;">${exercise.name.toUpperCase()}</h4><p class="exercise-muscles">${exercise.muscles.join(' â€¢ ')}</p></div><div style="display:flex;flex-direction:column;gap:4px;align-items:center;min-width:100px;flex-shrink: 0; margin-left: auto;"><button class="btn-history" onclick="showExerciseHistory('${exercise.name}')">History</button><span class="exercise-sets">${ex.sets} Ã— ${ex.reps}</span></div></div>
            <div class="sets-grid">${setsHtml}</div>
            <div style="display: flex; flex-direction: row; gap: 8px; margin-top: 40px; align-items: center;">
                <button class="btn btn-secondary btn-small btn-remove-set" onclick="removeSet('${exerciseKey}')" style="background: rgba(255, 61, 90, 0.1); padding-top: 25px; padding-bottom: 25px; border-color: #ff3d5a; color: #ff3d5a; width: 100%; max-width: 200px;" ${numSets <= 1 ? 'disabled' : ''}>âˆ’ Remove Set</button>
                <button class="btn btn-secondary btn-small btn-add-set" onclick="addSet('${exerciseKey}')" style="background: rgba(0, 255, 136, 0.1); padding-top: 25px; padding-bottom: 25px; border-color: var(--success); color: var(--success); width: 100%; max-width: 200px;">+ Add Set</button>
            </div>
            </div>`;
            }).join('');
        }

        function updateExerciseData(input) {
            const key = input.dataset.exercise, idx = parseInt(input.dataset.set), type = input.dataset.type;
            if (!currentExerciseData[key]) currentExerciseData[key] = {};
            if (!currentExerciseData[key][idx]) currentExerciseData[key][idx] = { isWarmup: idx === 0 };
            currentExerciseData[key][idx][type] = input.value;
            checkExerciseCompletion(key);
            saveWorkoutProgress(); // Save to localStorage
        }

        function toggleWarmup(btn) {
            const key = btn.dataset.exercise, idx = parseInt(btn.dataset.set);
            if (!currentExerciseData[key]) currentExerciseData[key] = {};
            if (!currentExerciseData[key][idx]) currentExerciseData[key][idx] = {};
            btn.classList.toggle('active');
            currentExerciseData[key][idx].isWarmup = btn.classList.contains('active');
            saveWorkoutProgress(); // Save to localStorage
        }

        function addSet(exerciseKey) {
            currentSetCounts[exerciseKey] = (currentSetCounts[exerciseKey] || 3) + 1;
            saveWorkoutProgress();
            renderExercises();
        }

        function removeSet(exerciseKey) {
            const currentCount = currentSetCounts[exerciseKey] || 3;
            if (currentCount > 1) {
                currentSetCounts[exerciseKey] = currentCount - 1;
                // Remove data for the last set
                const lastSetIndex = currentCount - 1;
                if (currentExerciseData[exerciseKey] && currentExerciseData[exerciseKey][lastSetIndex]) {
                    delete currentExerciseData[exerciseKey][lastSetIndex];
                }
                saveWorkoutProgress();
                renderExercises();
            }
        }

        function checkExerciseCompletion(key) {
            const el = document.getElementById(`exercise-${key}`);
            const inputs = el.querySelectorAll('.set-input');
            let complete = true;
            inputs.forEach(i => { if (!i.value) complete = false; });
            el.classList.toggle('completed', complete);
        }

        function validateAndCleanWorkout(exercises) {
            let hasZeroReps = false;
            const cleanedExercises = exercises.map(ex => {
                const cleanedSets = ex.sets.filter(set => {
                    const isZero = (parseInt(set.reps) || 0) === 0;
                    if (isZero) hasZeroReps = true;
                    return !isZero;
                });
                return { ...ex, sets: cleanedSets };
            }).filter(ex => ex.sets.length > 0);

            return { cleanedExercises, hasZeroReps };
        }

        async function completeWorkout(shouldExport = false) {
            if (currentWorkoutDay === 'rest') { alert('Today is a rest day!'); return null; }
            const workout = trainingPlan[currentWorkoutDay];
            const exercises = workout.exercises.map(ex => {
                const exercise = getExerciseForUI(ex.exerciseId);
                const key = `${currentWorkoutDay}_${ex.exerciseId}`;
                const numSets = currentSetCounts[key] || 3;
                const sets = Array.from({ length: numSets }, (_, i) => {
                    const setData = currentExerciseData[key]?.[i] || {};
                    let weight = parseFloat(setData.weight) || 0;
                    if (weightUnit === 'lbs' && weight > 0) weight = lbsToKg(weight);
                    return { weight, reps: parseInt(setData.reps) || 0, isWarmup: setData.isWarmup !== undefined ? setData.isWarmup : (i === 0), note: '' };
                });
                return { id: ex.exerciseId, name: exercise.name, sets };
            });

            const { cleanedExercises, hasZeroReps } = validateAndCleanWorkout(exercises);

            if (hasZeroReps) {
                pendingWorkoutData = { exercises: cleanedExercises, shouldExport, isEdit: false };
                document.getElementById('zeroRepsModal').classList.add('active');
                return null;
            }

            return await saveWorkoutData(cleanedExercises, shouldExport);
        }

        async function saveWorkoutData(exercises, shouldExport = false) {
            const workout = trainingPlan[currentWorkoutDay];
            const logId = Date.now();
            const log = { id: logId, date: new Date().toISOString(), workoutDay: currentWorkoutDay, workoutName: workout.name, exercises, weightUnit: 'kg' };

            console.log('LOGGING NEW WORKOUT TO FIREBASE:', logId);
            await saveToFirebase(log);

            const btn = document.getElementById('completeWorkoutBtn');
            if (btn) {
                const originalText = btn.textContent;
                btn.textContent = 'WORKOUT SAVED!';
                btn.classList.add('success');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('success');
                }, 2000);
            }

            workoutLogs.unshift(log);
            invalidateStatsCache();
            currentExerciseData = {};
            currentSetCounts = {};
            clearWorkoutProgress();
            renderExercises(); renderRecentLogs(); updateStats();
            if (shouldExport) exportSingleWorkout(log);
            return log;
        }

        function closeZeroRepsModal() {
            document.getElementById('zeroRepsModal').classList.remove('active');
            pendingWorkoutData = null;
        }

        async function confirmCompleteWorkout() {
            if (!pendingWorkoutData) return;
            const { exercises, shouldExport, isEdit } = pendingWorkoutData;
            closeZeroRepsModal();

            if (isEdit) {
                editingLogData.exercises = exercises;
                await finalizeEditedWorkoutSave();
            } else {
                await saveWorkoutData(exercises, shouldExport);
            }
        }




        function renderRecentLogs() {
            const container = document.getElementById('recentLogs');
            const recent = workoutLogs.slice(0, 5);
            if (recent.length === 0) { container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ðŸ“‹</div><p>No workouts logged yet</p></div>`; return; }
            container.innerHTML = recent.map(log => {
                const date = new Date(log.date);
                const totalSets = log.exercises.reduce((s, ex) => s + ex.sets.length, 0);
                const totalVolume = log.exercises.reduce((s, ex) => s + ex.sets.reduce((ss, set) => ss + (set.weight * set.reps), 0), 0);
                // Convert kg volume to lbs for display
                const displayVolume = Math.round(kgToLbs(totalVolume));
                return `<div class="log-entry"><div class="log-date">${date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div><div class="log-workout-name">${log.workoutName}</div><div class="log-stats">${totalSets} sets â€¢ ${displayVolume.toLocaleString()} lbs</div><div class="log-actions"><button class="btn btn-secondary btn-small" onclick="viewLogDetail('${log.id}')">View</button><button class="btn btn-export btn-small" onclick="exportSingleLog('${log.id}')">CSV</button></div></div>`;
            }).join('');
        }

        function exportSingleLog(id) { const log = workoutLogs.find(l => compareLogIds(l.id, id)); if (log) exportSingleWorkout(log); }

        function loadWorkoutForEditing(logId) {
            const log = workoutLogs.find(l => compareLogIds(l.id, logId));
            if (!log) return;

            // Store a deep copy to avoid direct mutation until saved
            editingLogData = JSON.parse(JSON.stringify(log));

            // Populate Modal UI
            document.getElementById('editModalTitle').textContent = `EDIT ${log.workoutName.toUpperCase()}`;
            const date = new Date(log.date);
            document.getElementById('editModalSubtitle').textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

            renderEditExercises();

            // Show the modal
            document.getElementById('editModal').classList.add('active');

            // Close the view detail modal
            closeExerciseModal();
        }

        function renderEditExercises() {
            const container = document.getElementById('editExerciseList');
            if (!editingLogData) return;

            container.innerHTML = editingLogData.exercises.map((ex, exIdx) => {
                const exercise = getExerciseForUI(ex.id) || { name: ex.name, muscles: [] };

                const setsHtml = ex.sets.map((set, setIdx) => {
                    // Convert kg to lbs for display in the modal
                    const weightLbs = set.weight > 0 ? displayWeight(set.weight) : '';
                    const isWarmup = set.isWarmup;

                    return `
                    <div class="set-input-group">
                        <span class="set-label">Set ${setIdx + 1}</span>
                        <button class="warmup-btn ${isWarmup ? 'active' : ''}"
                                onclick="toggleEditWarmup(${exIdx}, ${setIdx}, this)">W</button>
                        <div class="set-inputs">
                            <input type="number" class="set-input" placeholder="REPS"
                                   data-type="reps"
                                   value="${set.reps || ''}"
                                   onchange="updateEditExerciseData(${exIdx}, ${setIdx}, 'reps', this.value)">
                            <span class="input-separator">/</span>
                            <input type="number" class="set-input" placeholder="WEIGHT"
                                   data-type="weight"
                                   value="${weightLbs}"
                                   onchange="updateEditExerciseData(${exIdx}, ${setIdx}, 'weight', this.value)">
                        </div>
                    </div>`;
                }).join('');

                return `
                <div class="exercise-item">
                    <div class="exercise-header">
                        <div style="flex: 1; min-width: 0;">
                            <h4 class="exercise-name">${exercise.name.toUpperCase()}</h4>
                            <p class="exercise-muscles">${(exercise.muscles || []).join(' â€¢ ')}</p>
                        </div>
                    </div>
                    <div class="sets-grid">${setsHtml}</div>
                    <div style="display: flex; flex-direction: row; gap: 8px; margin-top: 40px; align-items: center;">
                        <button class="btn btn-secondary btn-small btn-remove-set" onclick="removeEditSet(${exIdx})" style="background: rgba(255, 61, 90, 0.1); padding-top: 25px; padding-bottom: 25px; border-color: #ff3d5a; color: #ff3d5a; width: 100%; max-width: 200px;" ${ex.sets.length <= 1 ? 'disabled' : ''}>âˆ’ Remove Set</button>
                        <button class="btn btn-secondary btn-small btn-add-set" onclick="addEditSet(${exIdx})" style="background: rgba(0, 255, 136, 0.1); padding-top: 25px; padding-bottom: 25px; border-color: var(--success); color: var(--success); width: 100%; max-width: 200px;">+ Add Set</button>
                    </div>
                </div>`;
            }).join('');
        }

        function addEditSet(exIdx) {
            if (!editingLogData) return;
            const ex = editingLogData.exercises[exIdx];
            // Add a new set with default values, mimicking the last set's weight if possible
            const lastSet = ex.sets[ex.sets.length - 1] || { weight: 0, reps: 0 };
            ex.sets.push({
                weight: lastSet.weight,
                reps: lastSet.reps,
                isWarmup: false,
                note: ''
            });
            renderEditExercises();
        }

        function removeEditSet(exIdx) {
            if (!editingLogData) return;
            const ex = editingLogData.exercises[exIdx];
            if (ex.sets.length > 1) {
                ex.sets.pop();
                renderEditExercises();
            }
        }

        function updateEditExerciseData(exIdx, setIdx, type, value) {
            if (!editingLogData) return;
            const set = editingLogData.exercises[exIdx].sets[setIdx];
            if (type === 'reps') {
                set.reps = parseInt(value) || 0;
            } else if (type === 'weight') {
                // Convert back to kg for storage
                let weight = parseFloat(value) || 0;
                if (weight > 0) weight = lbsToKg(weight);
                set.weight = weight;
            }
        }

        function toggleEditWarmup(exIdx, setIdx, btn) {
            if (!editingLogData) return;
            btn.classList.toggle('active');
            editingLogData.exercises[exIdx].sets[setIdx].isWarmup = btn.classList.contains('active');
        }

        async function saveEditedWorkout() {
            if (!editingLogData) return;

            const { cleanedExercises, hasZeroReps } = validateAndCleanWorkout(editingLogData.exercises);

            if (hasZeroReps) {
                pendingWorkoutData = { exercises: cleanedExercises, shouldExport: false, isEdit: true };
                document.getElementById('zeroRepsModal').classList.add('active');
                return;
            }

            editingLogData.exercises = cleanedExercises;
            await finalizeEditedWorkoutSave();
        }

        async function finalizeEditedWorkoutSave() {
            console.log('PREPARING TO SAVE EDITED WORKOUT TO FIREBASE:', editingLogData.id);

            try {
                // Save to Firebase - Use the original log ID and data structure
                await saveToFirebase(editingLogData);

                // Update local workoutLogs
                const index = workoutLogs.findIndex(l => compareLogIds(l.id, editingLogData.id));
                if (index !== -1) {
                    workoutLogs[index] = JSON.parse(JSON.stringify(editingLogData));
                }
                invalidateStatsCache();

                // Refresh UI
                renderRecentLogs();
                updateStats();
                if (document.getElementById('historyTab').style.display !== 'none') {
                    renderFullHistory();
                }

                // Success animation for save button
                const btn = document.getElementById('saveEditsBtn');
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = 'EDITS SAVED!';
                    btn.classList.add('success');

                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.classList.remove('success');
                        closeEditModal(); // Close modal after the animation/delay
                    }, 2000);
                } else {
                    alert('âœï¸ Workout updated and synced!');
                    closeEditModal();
                }
            } catch (error) {
                console.error('FAILED TO SAVE EDITED WORKOUT:', error);
                alert('âŒ Error saving changes. Please try again.');
            }
        }

        function closeEditModal() {
            editingLogData = null;
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editExerciseList').innerHTML = '';
        }

        // Delete Set Feature
        let selectedSetForDeletion = null;

        function flattenRecentSets() {
            const flatSets = [];
            // Look at the first 15 workouts or fewer if history is shorter
            const recentLogs = workoutLogs.slice(0, 15);

            for (const log of recentLogs) {
                let workoutHasSets = false;
                for (let exIdx = 0; exIdx < log.exercises.length; exIdx++) {
                    const exercise = log.exercises[exIdx];
                    const exerciseData = getExercise(exercise.id);
                    const exerciseName = exerciseData ? exerciseData.name : (exercise.name || 'Unknown Exercise');

                    const sets = exercise.sets || [];
                    if (sets.length > 0) workoutHasSets = true;

                    for (let setIdx = 0; setIdx < sets.length; setIdx++) {
                        const set = sets[setIdx];
                        flatSets.push({
                            workoutId: log.id,
                            workoutDate: log.date,
                            exerciseIndex: exIdx,
                            exerciseId: exercise.id,
                            exerciseName: exerciseName,
                            setIndex: setIdx,
                            weight: set.weight || 0, // stored in kg
                            reps: set.reps || 0,
                            isWarmup: set.isWarmup || false,
                            isEmptyWorkout: false
                        });
                    }
                }

                // If no sets were found in any exercise of this workout, add a placeholder
                if (!workoutHasSets) {
                    flatSets.push({
                        workoutId: log.id,
                        workoutDate: log.date,
                        exerciseIndex: 0,
                        exerciseId: 'empty',
                        exerciseName: '(Empty Workout)',
                        setIndex: 0,
                        weight: 0,
                        reps: 0,
                        isWarmup: false,
                        isEmptyWorkout: true
                    });
                }
            }

            // Sort globally: Date DESC, Exercise Index DESC, Set Index DESC
            // This puts the absolute newest sets (from the end of the session) at the top
            return flatSets.sort((a, b) => {
                if (b.workoutDate !== a.workoutDate) return b.workoutDate - a.workoutDate;
                if (b.exerciseIndex !== a.exerciseIndex) return b.exerciseIndex - a.exerciseIndex;
                return b.setIndex - a.setIndex;
            }).slice(0, 40); // Show up to 40 recent sets
        }

        function openDeleteSetModal() {
            selectedSetForDeletion = null;
            renderDeleteSetList();
            document.getElementById('deleteSetModal').classList.add('active');
        }

        function closeDeleteSetModal() {
            selectedSetForDeletion = null;
            document.getElementById('deleteSetModal').classList.remove('active');
        }

        function renderDeleteSetList() {
            const container = document.getElementById('deleteSetList');
            const sets = flattenRecentSets();

            if (sets.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ðŸ“‹</div><p>No sets found</p></div>`;
                return;
            }

            let html = `
                <table class="set-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Exercise</th>
                            <th>Weight</th>
                            <th>Reps</th>
                            <th>Type</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>`;

            sets.forEach((set, idx) => {
                const date = new Date(set.workoutDate);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const weightLbs = Math.round(kgToLbs(set.weight));
                const typeLabel = set.isWarmup ? 'Warmup' : 'Working';
                const typeColor = set.isWarmup ? 'var(--warning)' : 'var(--accent-secondary)';
                const isSelected = selectedSetForDeletion &&
                    compareLogIds(selectedSetForDeletion.workoutId, set.workoutId) &&
                    selectedSetForDeletion.exerciseIndex === set.exerciseIndex &&
                    selectedSetForDeletion.setIndex === set.setIndex;

                const emptyClass = set.isEmptyWorkout ? 'empty-workout-row' : '';

                if (isSelected) {
                    html += `
                        <tr class="selected ${emptyClass}" id="deleteRow_${idx}" style="position: relative; height: 50px;">
                            <td colspan="6" style="padding: 0; position: relative;">
                                <div class="delete-overlay" id="overlay_${idx}" onclick="event.stopPropagation()">
                                    <button class="delete-set-btn" id="deleteBtn_${idx}" onclick="event.stopPropagation(); confirmDeleteSet(${idx})">DELETE</button>
                                    <button class="cancel-set-btn" onclick="event.stopPropagation(); cancelSetDeletion()">CANCEL</button>
                                </div>
                            </td>
                        </tr>`;
                } else {
                    html += `
                        <tr class="${emptyClass}"
                            id="deleteRow_${idx}"
                            onclick="selectSetForDeletion(${idx})"
                            style="position: relative; ${set.isEmptyWorkout ? 'background: rgba(255,255,255,0.03); opacity: 0.8;' : ''}">
                            <td>${dateStr}</td>
                            <td style="${set.isEmptyWorkout ? 'color: var(--text-muted); font-style: italic;' : ''}">
                                <strong>${set.exerciseName}</strong>
                            </td>
                            <td>${set.isEmptyWorkout ? '<span style="color:var(--text-muted)">(Empty)</span>' : `${weightLbs} lbs`}</td>
                            <td>${set.isEmptyWorkout ? '<span style="color:var(--text-muted)">(Empty)</span>' : set.reps}</td>
                            <td style="color: ${set.isEmptyWorkout ? 'var(--text-muted)' : typeColor};">
                                ${set.isEmptyWorkout ? 'System Log' : typeLabel}
                            </td>
                            <td></td>
                        </tr>`;
                }
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function selectSetForDeletion(idx) {
            const sets = flattenRecentSets();
            const clickedSet = sets[idx];

            // If clicking the same row, deselect it
            if (selectedSetForDeletion &&
                compareLogIds(selectedSetForDeletion.workoutId, clickedSet.workoutId) &&
                selectedSetForDeletion.exerciseIndex === clickedSet.exerciseIndex &&
                selectedSetForDeletion.setIndex === clickedSet.setIndex) {
                selectedSetForDeletion = null;
            } else {
                selectedSetForDeletion = clickedSet;
            }
            renderDeleteSetList();
        }

        function cancelSetDeletion() {
            selectedSetForDeletion = null;
            renderDeleteSetList();
        }

        function confirmDeleteSet(idx) {
            const btn = document.getElementById(`deleteBtn_${idx}`);
            const overlay = document.getElementById(`overlay_${idx}`);
            if (!btn) return;

            if (btn.textContent === 'DELETE') {
                btn.textContent = 'Sure?';
                btn.style.background = '#661414';
                btn.style.color = '#c62828';
                btn.style.border = '2px solid #c62828';
                btn.style.fontWeight = 'bold';

                if (overlay) {
                    overlay.style.background = 'rgba(198, 40, 40, 0.7)';
                }
            } else if (btn.textContent === 'Sure?') {
                executeDeleteSet(idx);
            }
        }

        async function executeDeleteSet(idx) {
            if (!selectedSetForDeletion) return;

            const overlay = document.getElementById(`overlay_${idx}`);

            // Show green "Deleted!" overlay
            if (overlay) {
                overlay.classList.add('deleted-state');
                overlay.innerHTML = '<span style="font-family: \'Bebas Neue\', sans-serif; font-size: 1.5rem; letter-spacing: 2px; color: #fff;">DELETED!</span>';
            }

            const { workoutId, exerciseIndex, setIndex, isEmptyWorkout } = selectedSetForDeletion;

            console.log('DELETING SET FROM FIREBASE:', { workoutId, exerciseIndex, setIndex, isEmptyWorkout });

            // Small delay for the "Deleted!" visual
            await new Promise(r => setTimeout(r, 600));

            try {
                // Find the workout
                const workoutIdx = workoutLogs.findIndex(l => compareLogIds(l.id, workoutId));
                if (workoutIdx === -1) {
                    alert('âŒ Workout not found');
                    return;
                }

                if (isEmptyWorkout) {
                    // It's an empty workout placeholder - delete the entire document
                    await deleteFromFirebase(workoutId);
                    workoutLogs.splice(workoutIdx, 1);
                } else {
                    const workout = JSON.parse(JSON.stringify(workoutLogs[workoutIdx]));

                    // Remove the set
                    workout.exercises[exerciseIndex].sets.splice(setIndex, 1);

                    // If exercise has no sets left, remove the exercise
                    if (workout.exercises[exerciseIndex].sets.length === 0) {
                        workout.exercises.splice(exerciseIndex, 1);
                    }

                    // If workout has no exercises left, delete the entire workout
                    if (workout.exercises.length === 0) {
                        await deleteFromFirebase(workoutId);
                        workoutLogs.splice(workoutIdx, 1);
                    } else {
                        // Update the workout
                        await saveToFirebase(workout);
                        workoutLogs[workoutIdx] = workout;
                    }
                }
                invalidateStatsCache();

                // Refresh UI
                renderRecentLogs();
                updateStats();
                if (document.getElementById('historyTab').style.display !== 'none') {
                    renderFullHistory();
                }

                // Keep the row showing "Deleted!" - don't re-render
                selectedSetForDeletion = null;
            } catch (error) {
                console.error('FAILED TO DELETE SET:', error);
                alert('âŒ Error deleting set. Please try again.');
            }
        }



        function viewLogDetail(id) {
            const log = workoutLogs.find(l => compareLogIds(l.id, id));
            if (!log) return;
            const date = new Date(log.date);
            let html = `<p style="color: var(--text-muted); margin-bottom: 16px;">${date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>`;
            log.exercises.forEach(ex => {
                const exerciseId = ex.exerciseId;
                html += `<div style="margin-bottom: 16px;"><h4 style="font-family: 'Bebas Neue'; margin-bottom: 8px; cursor: pointer;" onclick="showInstructions('${exerciseId}')">${ex.name}</h4><div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">${ex.sets.map((set, i) => `<div style="background: var(--bg-tertiary); padding: 8px; text-align: center; font-size: 0.8rem; border-left: 2px solid ${set.isWarmup ? 'var(--warning)' : 'var(--accent-primary)'};"><div style="font-size: 0.77rem; color: var(--text-muted);">${set.isWarmup ? 'WARM' : 'SET ' + (i + 1)}</div><div>${displayWeight(set.weight)}lbs Ã— ${set.reps}</div></div>`).join('')}</div></div>`;
            });
            document.getElementById('modalExerciseName').textContent = log.workoutName;
            document.getElementById('modalExerciseDetails').innerHTML = html;

            // Store the log ID for the Edit button and show it
            const modal = document.getElementById('exerciseModal');
            modal.dataset.logId = id;
            const editBtn = modal.querySelector('.btn-primary');
            if (editBtn) editBtn.style.display = '';

            modal.classList.add('active');
        }

        function closeExerciseModal() { document.getElementById('exerciseModal').classList.remove('active'); }

        function closeHistoryModal() { document.getElementById('historyModal').classList.remove('active'); }

        function closeInstructionsModal() { document.getElementById('instructionsModal').classList.remove('active'); }

        function showInstructions(exerciseId) {
            const exercise = getExerciseForUI(exerciseId);
            if (exercise) {
                document.getElementById('instructionsModalTitle').textContent = exercise.name.toUpperCase();
                document.getElementById('instructionsModalContent').textContent = exercise.instructions || "No instructions given";
                document.getElementById('instructionsModal').classList.add('active');
            }
        }

        function showExerciseHistory(exerciseName) {
            // Search through all workout logs to find the most recent occurrence of this exercise
            let mostRecentLog = null;
            let mostRecentExercise = null;
            let mostRecentDate = null;

            // workoutLogs is already sorted by date descending, so first match is most recent
            for (const log of workoutLogs) {
                const exercise = log.exercises.find(ex => {
                    const nameMatch = ex.name.toLowerCase() === exerciseName.toLowerCase() ||
                        ex.name.toLowerCase().includes(exerciseName.toLowerCase()) ||
                        exerciseName.toLowerCase().includes(ex.name.toLowerCase());
                    return nameMatch && ex.sets && ex.sets.length > 0;
                });
                if (exercise) {
                    mostRecentLog = log;
                    mostRecentExercise = exercise;
                    mostRecentDate = new Date(log.date);
                    break;
                }
            }

            const modal = document.getElementById('historyModal');
            const title = document.getElementById('historyModalTitle');
            const content = document.getElementById('historyModalContent');

            title.textContent = exerciseName.toUpperCase() + ' HISTORY';

            if (!mostRecentExercise) {
                content.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ðŸ“Š</div><p>No history found for this exercise</p></div>`;
            } else {
                const dateStr = mostRecentDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });

                let html = `<p class="history-date">Most recent: <strong>${dateStr}</strong></p>`;
                html += `<div style="margin-top: 12px;">`;

                mostRecentExercise.sets.forEach((set, i) => {
                    const weightLbs = displayWeight(set.weight);
                    const warmupClass = set.isWarmup ? 'warmup' : '';
                    const label = set.isWarmup ? 'WARM' : `SET ${i + 1}`;
                    html += `<div class="history-set ${warmupClass}">
                        <span>${label}</span>
                        <span><strong>${weightLbs} lbs</strong> Ã— ${set.reps} reps</span>
                    </div>`;
                });

                html += `</div>`;
                content.innerHTML = html;
            }

            modal.classList.add('active');
        }

        function updateStats() {
            // Check if we can use cached stats
            if (cachedStats && cachedStats.version === cachedStatsVersion) {
                document.getElementById('totalWorkouts').textContent = cachedStats.totalWorkouts;
                document.getElementById('totalSets').textContent = cachedStats.totalSets;
                document.getElementById('totalVolume').textContent = cachedStats.totalVolume;
                document.getElementById('currentStreak').textContent = cachedStats.streak;
                return;
            }

            // Recalculate stats
            const totalWorkouts = workoutLogs.length;
            const totalSets = workoutLogs.reduce((s, log) => s + log.exercises.reduce((ss, ex) => ss + ex.sets.length, 0), 0);
            const totalVolume = workoutLogs.reduce((s, log) => s + log.exercises.reduce((ss, ex) => ss + ex.sets.reduce((sss, set) => sss + (set.weight * set.reps), 0), 0), 0);
            let streak = 0;
            const today = new Date(); today.setHours(0, 0, 0, 0);
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const hasWorkout = workoutLogs.some(log => new Date(log.date).toDateString() === checkDate.toDateString());
                const isRestDay = dayToWorkout[checkDate.getDay()] === 'rest';

                if (hasWorkout) {
                    streak++;
                } else if (isRestDay) {
                    // Rest day continues streak but doesn't increment count
                    continue;
                } else if (i === 0) {
                    // Today's workout pending - continue to check yesterday
                    continue;
                } else {
                    // Missed expected workout day
                    break;
                }
            }

            const displayVolume = Math.round(kgToLbs(totalVolume)).toLocaleString();

            // Cache the calculated stats
            cachedStats = {
                totalWorkouts: totalWorkouts,
                totalSets: totalSets,
                totalVolume: displayVolume,
                streak: streak,
                version: cachedStatsVersion
            };

            // Update DOM
            document.getElementById('totalWorkouts').textContent = totalWorkouts;
            document.getElementById('totalSets').textContent = totalSets;
            document.getElementById('totalVolume').textContent = displayVolume;
            document.getElementById('currentStreak').textContent = streak;
        }

        function renderPlanView() {
            const container = document.getElementById('planDays');
            const days = ['day1', 'day2', 'day3', 'rest', 'day4', 'day5', 'day6'];
            const labels = ['Sunday', 'Monday', 'Tuesday', 'Wednesday (Off)', 'Thursday', 'Friday', 'Saturday'];
            container.innerHTML = days.map((day, idx) => {
                const workout = trainingPlan[day];
                const isRest = day === 'rest';
                return `<div class="plan-day" id="plan-${day}"><div class="plan-day-header" onclick="togglePlanDay('${day}')"><div><div class="plan-day-title">${isRest ? 'REST DAY' : `DAY ${day.replace('day', '')} - ${workout.name}`}</div><div class="plan-day-subtitle">${labels[idx]} â€¢ ${workout.subtitle}</div></div><span class="toggle-arrow">â–¼</span></div><div class="plan-day-exercises">${isRest ? '<p style="color: var(--text-muted); padding-top: 12px;">Complete rest or light activity</p>' : workout.exercises.map(ex => { const exercise = getExerciseForUI(ex.exerciseId); return `<div class="plan-exercise"><div style="display: flex; justify-content: space-between;"><span style="font-weight: bold; cursor: pointer;" onclick="showInstructions('${exercise.id}')">${exercise.name}</span><span style="color: var(--accent-secondary);">${ex.sets} Ã— ${ex.reps}</span></div></div>`; }).join('')}</div></div>`;
            }).join('');
        }

        function togglePlanDay(day) { document.getElementById(`plan-${day}`).classList.toggle('expanded'); }

        function renderLibrary() {
            const categories = [...new Set(exerciseDatabase.map(e => e.category))];
            document.getElementById('muscleFilter').innerHTML = `<span class="filter-chip ${!activeFilter ? 'active' : ''}" onclick="filterLibrary(null)">All</span>${categories.map(cat => `<span class="filter-chip ${activeFilter === cat ? 'active' : ''}" onclick="filterLibrary('${cat}')">${cat}</span>`).join('')}`;
            const searchTerm = document.getElementById('librarySearch')?.value?.toLowerCase() || '';
            const filtered = exerciseDatabase.filter(ex => (ex.name.toLowerCase().includes(searchTerm) || ex.muscles.some(m => m.toLowerCase().includes(searchTerm))) && (!activeFilter || ex.category === activeFilter));
            document.getElementById('libraryGrid').innerHTML = filtered.map(ex => `<div class="library-exercise" onclick="showExerciseInfo('${ex.id}')"><h4 class="library-exercise-name">${ex.name}</h4><p class="library-exercise-muscles">${ex.muscles.join(' â€¢ ')}</p><span class="library-exercise-category">${ex.category}</span></div>`).join('');
        }

        function filterLibrary(category) { activeFilter = category; renderLibrary(); }

        function showExerciseInfo(id) {
            const ex = getExerciseForUI(id);
            if (!ex) return;
            document.getElementById('modalExerciseName').textContent = ex.name;
            document.getElementById('modalExerciseDetails').innerHTML = `<p><strong>Category:</strong> ${ex.category}</p><p><strong>Equipment:</strong> ${ex.equipment}</p><p><strong>Target:</strong> ${ex.muscles.join(', ')}</p><hr style="border-color: var(--border); margin: 16px 0;"><p style="margin-bottom: 16px;"><strong>Instructions:</strong><br>${ex.instructions || "No instructions given"}</p><hr style="border-color: var(--border); margin: 16px 0;"><p style="font-size: 0.8rem; color: var(--text-muted);"><strong>CSV Name:</strong> ${getExportName(id)}</p><p style="font-size: 0.8rem; color: var(--text-muted);"><strong>Multiplier:</strong> ${getMultiplier(id)}</p>`;
            // Hide Edit button for library view
            const modal = document.getElementById('exerciseModal');
            modal.dataset.logId = '';
            const editBtn = modal.querySelector('.btn-primary');
            if (editBtn) editBtn.style.display = 'none';
            modal.classList.add('active');
        }

        function switchWorkout() {
            const days = ['day1', 'day2', 'day3', 'rest', 'day4', 'day5', 'day6'];
            const labels = ['Sunday - Day 1', 'Monday - Day 2', 'Tuesday - Day 3', 'Wednesday - Rest', 'Thursday - Day 4', 'Friday - Day 5', 'Saturday - Day 6'];
            document.getElementById('daySelector').innerHTML = days.map((day, idx) => {
                const workout = trainingPlan[day];
                const isCurrent = day === currentWorkoutDay;
                return `<div style="padding: 12px; margin-bottom: 8px; background: ${isCurrent ? 'rgba(255,61,0,0.1)' : 'var(--bg-tertiary)'}; border: 1px solid ${isCurrent ? 'var(--accent-primary)' : 'var(--border)'}; cursor: pointer;" onclick="selectWorkoutDay('${day}')"><div style="font-family: 'Bebas Neue'; font-size: 1.1rem;">${workout.name}</div><div style="font-size: 0.87rem; color: var(--text-muted);">${labels[idx]}</div></div>`;
            }).join('');
            document.getElementById('switchModal').classList.add('active');
        }

        function selectWorkoutDay(day) { currentWorkoutDay = day; currentExerciseData = {}; updateWorkoutDisplay(true); closeSwitchModal(); }
        function closeSwitchModal() { document.getElementById('switchModal').classList.remove('active'); }

        function setupTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;

                    if (tabName === 'workout') {
                        const todaysDay = dayToWorkout[new Date().getDay()];
                        const workoutTab = document.getElementById('workoutTab');
                        const isWorkoutTabVisible = workoutTab.style.display !== 'none';
                        const isShowingToday = currentWorkoutDay === todaysDay;

                        if (isWorkoutTabVisible && isShowingToday) {
                            document.getElementById('workoutCard').scrollIntoView({ behavior: 'smooth' });
                            return;
                        }

                        // Switch to today's workout if not showing it
                        currentWorkoutDay = todaysDay;
                        updateWorkoutDisplay(true);
                    }

                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');

                    if (tabName === 'workout') document.getElementById('workoutTab').style.display = 'block';
                    else if (tabName === 'plan') { document.getElementById('planTab').style.display = 'block'; document.getElementById('planTab').classList.add('active'); }
                    else if (tabName === 'library') { document.getElementById('libraryTab').style.display = 'block'; document.getElementById('libraryTab').classList.add('active'); }
                    else if (tabName === 'history') { document.getElementById('historyTab').style.display = 'block'; renderFullHistory(); }
                });
            });
            document.getElementById('librarySearch').addEventListener('input', renderLibrary);
        }

        async function loadAllHistory() {
            await loadFromFirebase(0); // 0 = no limit, load everything
            renderFullHistory();
            renderRecentLogs();
            updateStats();
        }

        function renderFullHistory() {
            const container = document.getElementById('fullHistory');
            const subtitle = document.getElementById('historySubtitle');

            if (workoutLogs.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ðŸ“‹</div><p>No workouts logged yet!</p></div>`;
                if (subtitle) subtitle.textContent = '';
                return;
            }

            // Update subtitle based on whether full history is loaded
            if (subtitle) {
                subtitle.textContent = isFullHistoryLoaded
                    ? `Showing all ${workoutLogs.length} workouts`
                    : `Showing ${workoutLogs.length} most recent workouts`;
            }

            const loadAllButton = !isFullHistoryLoaded
                ? `<button class="btn btn-secondary" onclick="loadAllHistory()" style="background: rgba(255, 187, 0, 0.1); border-color: var(--warning); color: var(--warning);">LOAD ALL HISTORY</button>`
                : '';

            container.innerHTML = `<div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;"><button class="btn btn-export" onclick="exportToCSV()">EXPORT ALL TO CSV</button><button class="btn btn-secondary" onclick="openDeleteSetModal()" style="background: rgba(255, 61, 90, 0.1); border-color: #ff3d5a; color: #ff3d5a;">DELETE SETS</button>${loadAllButton}</div>` + workoutLogs.map(log => {
                const date = new Date(log.date);
                const totalSets = log.exercises.reduce((s, ex) => s + ex.sets.length, 0);
                const totalVolume = log.exercises.reduce((s, ex) => s + ex.sets.reduce((ss, set) => ss + (set.weight * set.reps), 0), 0);
                const displayVolume = Math.round(kgToLbs(totalVolume));
                return `<div class="log-entry"><div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 12px;"><div><div class="log-date">${date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</div><div class="log-workout-name">${log.workoutName}</div><div class="log-stats">${totalSets} sets â€¢ ${displayVolume.toLocaleString()} lbs</div></div><div class="log-actions"><button class="btn btn-secondary btn-small" onclick="viewLogDetail('${log.id}')">View</button><button class="btn btn-export btn-small" onclick="exportSingleLog('${log.id}')">CSV</button></div></div></div>`;
            }).join('');
        }



        init();
    </script>
</body>

</html>